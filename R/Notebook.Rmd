---
title: "Oyster ploidy field study survival analysis"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
  theme: sky
  code_folding: hide
---

Survival analysis to the end of 2023 for oyster ploidy project

## Read in the data and create basic tables and graphs

Load the required packages

```{r, results=FALSE, warning=FALSE, error=FALSE, message=FALSE, }
library(tidyverse)
library(here)
library(survival)
```

Read in the mortality data from the field experiments

```{r}
survdat <- read.csv(here("Data", "MAY_SEPT_2023_MORTSBYBAG.csv"))
```

Correct the data structure

```{r}
survdat <- survdat %>% mutate_at(c("Site", "Bag_Col", "Month", "Bag_no", "Month_no"), as.factor)
str(survdat)
```

Create a new data sheet that calculates the number of survivors at each sampling event (as opposed to the number of moralities)

```{r}
widebagmort <- pivot_wider(survdat[-c(6)], names_from = Month, values_from = Mort_count)
#replace NA in the mortality columns with 0
widebagmort <- widebagmort %>%
  mutate_at(vars(May, June, July, Aug, September), ~replace_na(., 0))
widebagmort$May_survivors <- 50-widebagmort$May
widebagmort$June_survivors <- widebagmort$May_survivors-widebagmort$June
widebagmort$July_survivors <- widebagmort$June_survivors-widebagmort$July
widebagmort$Aug_survivors <- widebagmort$July_survivors-widebagmort$Aug
widebagmort$Sept_survivors <- widebagmort$Aug_survivors-widebagmort$September

no_survivors <- widebagmort %>% pivot_longer(cols=c(9:12),
                                                         names_to='Month_survivor',
                                                         values_to='No_survivors') %>% 
  select("Site", "Bag_Col", "Bag_no",'Month_survivor','No_survivors')
no_survivors$Month_survivor <- as.factor(no_survivors$Month_survivor)
no_survivors
```

Double check that all bags are accounted for. There should be 8 bags per site per sampling event = 32 as of September 2023

```{r, echo=FALSE}
no_survivors %>% group_by(Site, Bag_Col) %>% summarise(nbags=n())
```

Sumarise the number of survivors per site per sampling event

```{r, echo=FALSE}
mean_survival_proportion <- no_survivors %>% 
  group_by(Site, Bag_Col, Month_survivor) %>% 
  summarise(meansurv=mean(No_survivors), semsurv=sd(No_survivors)/sqrt(n()))

mean_survival_proportion
```

Create a basic survival plot taht shows the number of survivors at each sampling event

```{r, echo=FALSE}


mean_survival_proportion %>% ggplot(aes(x=factor(Month_survivor, level=c('May_survivors', 'June_survivors', 'July_survivors', 'Aug_survivors', 'Sept_survivors')), 
             y=meansurv, colour = Bag_Col, group=Bag_Col))+
  scale_x_discrete(labels=c('May', 'June', 'July', 'August', 'September'))+
  scale_color_manual(values=c('blue', 'green', 'red'), name = "Ploidy", labels = c("Diploid", "Induced Triploid", "Mated Triploid"))+
  geom_errorbar(aes(ymin=meansurv-semsurv, ymax=meansurv+semsurv))+
  geom_line()+facet_grid(~Site)+
  xlab("Month")+ylab("Mean number of survivors per bag (Â± SEM)")+
  theme_bw()+ggtitle("Number of survivors since experiment start")
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
